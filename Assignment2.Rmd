# Package Downloads
```{r echo=FALSE}
if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager", repos = "https://cloud.r-project.org")
BiocManager::install(version = "3.21")
if (!requireNamespace("DESeq2", quietly = TRUE)) {
  BiocManager::install("DESeq2")
}
install.packages("devtools", repos = "https://cloud.r-project.org")
install.packages("GenomeInfoDb", repos = "https://cloud.r-project.org")
install.packages("tidyverse", repos = "https://cloud.r-project.org")
# Install the Homo Sapiens package
if (!("org.Hs.eg.db" %in% installed.packages())) {
  BiocManager::install("org.Hs.eg.db", update = FALSE)
}

```

# Section 1a

```{r}
# Attach the library
library(org.Hs.eg.db)

# We will need this so we can use the pipe: %>%
library(magrittr)

# Create the data folder if it doesn't exist
if (!dir.exists("data")) {
  dir.create("data")
}

# Define the file path to the plots directory
plots_dir <- "plots"

# Create the plots folder if it doesn't exist
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}

# Define the file path to the results directory
results_dir <- "results"

# Create the results folder if it doesn't exist
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}

# Define the file path to the data directory
data_dir <- file.path("data", "SRP192714")

# Declare the file path to the gene expression matrix file
data_file <- file.path(data_dir, "SRP192714.tsv")

# Read in data TSV file
expression_df <- readr::read_tsv(data_file) %>%
  tibble::column_to_rownames("Gene")

```

# Section 1b

```{r}
# Bring back the "Gene" column in preparation for mapping
expression_df <- expression_df %>%
  tibble::rownames_to_column("Gene")

# Map Ensembl IDs to their first mapped Symbol
gene_symbols <- mapIds(
  org.Hs.eg.db,
  keys = expression_df$Gene,
  keytype = "ENSEMBL",
  column = "SYMBOL",
  multiVals = "first"
)

# Add the mapped symbols as a new column
expression_df$Symbol <- gene_symbols[expression_df$Gene]

# Reorder columns to have Gene, Symbol, then the rest
expression_df <- expression_df %>%
  dplyr::select(Gene, Symbol, dplyr::everything(), -Gene)

# Write mapped data frame to output file
readr::write_tsv(expression_df, file.path(
  results_dir,
  "SRP192714_Symbols.tsv"
))
```

# Section 1c
```{r}

# Get matrix size
matrix_dim <- dim(expression_df)
cat("Expression matrix dimensions (genes x samples):", matrix_dim[1], "x", matrix_dim[2], "\n")

# Number of genes
cat("Number of genes:", nrow(expression_df), "\n")

# Select only numeric columns for log transformation
expr_numeric <- expression_df %>% dplyr::select(where(is.numeric))

# Log-scale the data (add pseudocount to avoid log(0))
log_expr <- log2(expr_numeric + 1)

# Calculate per-gene median expression
gene_medians <- apply(log_expr, 1, median, na.rm = TRUE)

# Show summary statistics for gene medians
summary(gene_medians)

# Density plot of per-gene median expression
library(ggplot2)
plot_obj <- ggplot(data.frame(median=gene_medians), aes(x=median)) +
  geom_density(fill="skyblue", alpha=0.5) +
  labs(title="Density of Per-Gene Median Expression (log2 scale)",
       x="Median log2(expression + 1)",
       y="Density")

# Save plot to the plots directory
plot_path <- file.path(plots_dir, "per_gene_median_density.png")
ggsave(plot_path, plot=plot_obj, width=6, height=4, dpi=300)

# Also print the plot in the notebook
plot_obj
```

The dataset contains 43,363 genes measured across 1,022 samples. The summary statistics show that most genes have low median expression (median ≈ 0.26 on log2 scale), with a long tail of higher expression values (max ≈ 7.6). From our research, this is typical for transcriptome data, where a small number of genes are highly expressed while the majority have low expression. The density plot visualizes this distribution, showing a peak at lower expression values and a gradual decline towards higher values. Log transformation helps to reduce the impact of extreme values and makes the distribution more interpretable.

# Section 2a

```{r}
library(DESeq2)

# Use numeric columns from expression_df as count matrix
cts <- expression_df %>% dplyr::select(where(is.numeric)) %>% as.matrix()


# Load refine.bio metadata
refinebio_meta <- readr::read_tsv(file.path(data_dir, "metadata_SRP192714.tsv"))
rownames(refinebio_meta) <- refinebio_meta$refinebio_accession_code

# Load GEO metadata (CSV)
geo_meta <- readr::read_csv("data/GSE129882_PhenoData.transcript.csv")

# Try to merge on sample columns
# Check for a column in geo_meta that matches refinebio_accession_code or another sample identifier
# For demonstration, let's assume geo_meta has a column 'Sample' that matches refinebio_accession_code
if ("Sample" %in% colnames(geo_meta)) {
  merged_meta <- dplyr::left_join(refinebio_meta, geo_meta, by = c("refinebio_accession_code" = "Sample"))
} else {
  # If not, just keep refinebio_meta as coldata
  merged_meta <- refinebio_meta
}

# Update coldata for DESeq2
coldata <- merged_meta
rownames(coldata) <- coldata$refinebio_accession_code

# Subset cts columns to match coldata rownames
cts <- cts[, rownames(coldata)]

# Check dimensions
stopifnot(ncol(cts) == nrow(coldata))

# Choose a grouping column for DESeq2 (update as needed)
# For example, use 'refinebio_title' or a column from GEO metadata
dds <- DESeqDataSetFromMatrix(countData = cts,
                              colData = coldata,
                              design = ~ refinebio_title)

dds <- DESeq(dds)
vsd <- vst(dds, blind=FALSE)
plotPCA(vsd, intgroup="refinebio_title")
```

# Section 2b
```{r}

```

# Section 2c
```{r}

```

# Section 2d i
```{r}

```

# Section 2d ii
```{r}

```

# Section 2e

# Section 2f
```{r}

```

# Section 3a-b
```{r section3ab, echo = FALSE}

# # Attach the DESeq2 library
# library(DESeq2)

# # Attach the ggplot2 library for plotting
# library(ggplot2)

# # We will need this so we can use the pipe: %>%
# library(magrittr)

# set.seed(12345)

# metadata <- readr::read_tsv("C:/Users/Nsang/BioinformaticsProject/data/SRP192714/metadata_SRP192714.tsv")
# # Read in data TSV file
# expression_df <- readr::read_tsv("C:/Users/Nsang/BioinformaticsProject/data/SRP192714/SRP192714.tsv") %>%
#   tibble::column_to_rownames("Gene")

# # Make the data in the order of the metadata
# expression_df <- expression_df %>%
#   dplyr::select(metadata$refinebio_accession_code)

# # Check if this is in the same order
# all.equal(colnames(expression_df), metadata$refinebio_accession_code)

# metadata <- metadata %>%
#   # Let's get the RPL10 mutation status from this variable
#   dplyr::mutate(mutation_status = dplyr::case_when(
#     stringr::str_detect(refinebio_title, "R98S") ~ "R98S",
#     stringr::str_detect(refinebio_title, "WT") ~ "reference"
#   ))

# # Print out a preview of `mutation_status`
# str(metadata$mutation_status)

# # Make mutation_status a factor and set the levels appropriately
# metadata <- metadata %>%
#   dplyr::mutate(
#     # Here we define the values our factor variable can have and their order.
#     mutation_status = factor(mutation_status, levels = c("reference", "R98S"))
#   )

# # Define a minimum counts cutoff and filter the data to include
# # only rows (genes) that have total counts above the cutoff
# filtered_expression_df <- expression_df %>%
#   dplyr::filter(rowSums(.) >= 10)

# # round all expression counts
# gene_matrix <- round(filtered_expression_df)

# ddset <- DESeqDataSetFromMatrix(
#   # Here we supply non-normalized count data
#   countData = gene_matrix,
#   # Supply the `colData` with our metadata data frame
#   colData = metadata,
#   # Supply our experimental variable to `design`
#   design = ~mutation_status
# )

# deseq_object <- DESeq(ddset)
# deseq_results <- results(deseq_object)

# deseq_results <- lfcShrink(
#   deseq_object, # The original DESeq2 object after running DESeq()
#   coef = 2, # The log fold change coefficient used in DESeq(); the default is 2.
#   res = deseq_results # The original DESeq2 results table
# )

# # this is of class DESeqResults -- we want a data frame
# deseq_df <- deseq_results %>%
#   # make into data.frame
#   as.data.frame() %>%
#   # the gene names are row names -- let's make them a column for easy display
#   tibble::rownames_to_column("Gene") %>%
#   # add a column for significance threshold results
#   dplyr::mutate(threshold = padj < 0.05) %>%
#   # sort by statistic -- the highest values will be genes with
#   # higher expression in RPL10 mutated samples
#   dplyr::arrange(dplyr::desc(log2FoldChange))

#   plotCounts(ddset, gene = "ENSMUSG00000026623", intgroup = "mutation_status")
# readr::write_tsv(
#   deseq_df,
#   file.path(
#     results_dir,
#     "SRP123625_diff_expr_results.tsv" # Replace with a relevant output file name
#   )
# )
# # We'll assign this as `volcano_plot`
# volcano_plot <- EnhancedVolcano::EnhancedVolcano(
#   deseq_df,
#   lab = deseq_df$Gene,
#   x = "log2FoldChange",
#   y = "padj",
#   pCutoff = 0.01 # Loosen the cutoff since we supplied corrected p-values
# )
# volcano_plot
# ggsave(
#   plot = volcano_plot,
#   file.path(plots_dir, "SRP123625_volcano_plot.png")
# ) # Replace with a plot name relevant to your data
# Load required packages
library(readr); library(dplyr); library(stringr); library(magrittr)
library(tibble); library(DESeq2); library(apeglm); library(EnhancedVolcano)
library(ggplot2)

# Paths (use project-relative paths)
metadata_path <- "data/SRP192714/metadata_SRP192714.tsv"
expr_path     <- "data/SRP192714/SRP192714.tsv"

# Read metadata and expression
metadata <- readr::read_tsv(metadata_path)

expression_df <- readr::read_tsv(expr_path) %>%
  tibble::column_to_rownames(var = "Gene")   # ensure 'Gene' is the column name

# Reorder expression columns to match the metadata samples (use all_of for safety)
# Make sure metadata$refinebio_accession_code contains the sample column names exactly.
expression_df <- expression_df %>% dplyr::select(all_of(metadata$refinebio_accession_code))

# Verify alignment
stopifnot(all.equal(colnames(expression_df), metadata$refinebio_accession_code))

# Create mutation_status from title (adjust regex to your data)
metadata <- metadata %>%
  dplyr::mutate(mutation_status = dplyr::case_when(
    stringr::str_detect(refinebio_title, "R98S") ~ "R98S",
    stringr::str_detect(refinebio_title, "WT") ~ "reference",
    TRUE ~ NA_character_
  ))

# Make sure mutation_status is a factor with desired levels
metadata$mutation_status <- factor(metadata$mutation_status, levels = c("reference", "R98S"))

# Filter low-count genes (sum across samples)
filtered_expression_df <- expression_df[rowSums(expression_df) >= 10, , drop = FALSE]

# Convert to integer matrix (DESeq2 expects counts)
gene_matrix <- round(as.matrix(filtered_expression_df))

# Ensure rownames are genes and column order matches metadata rows order
# (metadata rows must be in the same order as columns; if not, reorder metadata:)
metadata <- metadata[match(colnames(gene_matrix), metadata$refinebio_accession_code), ]

# Construct DESeq2 object
dds <- DESeqDataSetFromMatrix(countData = gene_matrix,
                              colData = metadata,
                              design = ~ mutation_status)

dds <- DESeq(dds)

res <- results(dds)                 # raw results
res_shrunk <- lfcShrink(dds, coef = 2, type = "apeglm", res = res)  # requires apeglm

# Convert to tidy data.frame
deseq_df <- as.data.frame(res_shrunk) %>%
  tibble::rownames_to_column("Gene") %>%
  dplyr::mutate(threshold = ifelse(is.na(padj), FALSE, padj < 0.05)) %>%
  dplyr::arrange(dplyr::desc(log2FoldChange))

# Example count plot for a single gene
plotCounts(dds, gene = "ENSMUSG00000026623", intgroup = "mutation_status")  # adjust gene name

# Save results (ensure results_dir exists)
results_dir <- "results"
if (!dir.exists(results_dir)) dir.create(results_dir)
readr::write_tsv(deseq_df, file.path(results_dir, "SRP192714_diff_expr_results.tsv"))

# Volcano plot
volcano_plot <- EnhancedVolcano::EnhancedVolcano(
  deseq_df,
  lab = deseq_df$Gene,
  x = "log2FoldChange",
  y = "padj",
  pCutoff = 0.01
)

# Save volcano
plots_dir <- "plots"
if (!dir.exists(plots_dir)) dir.create(plots_dir)
ggsave(plot = volcano_plot, filename = file.path(plots_dir, "SRP192714_volcano_plot.png"), width = 8, height = 6)
```

# Section 3c
```{r}

```

# Section 3d
```{r}

```

# Section 3e
```{r}

```

# Section 4a
```{r}

```

# Section 4c
```{r}

```

# Section 5: William Le
```{r}

```

# Section 5: Nikhil Sangamkar
```{r}

```

# Section 5: Taylor Tillander
```{r}

```

# Section 5: Ibrahim Zbib
```{r}

```

# Section 6
```{r}

```

# Section 7
```{r}

```